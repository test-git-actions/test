name: Download File from Issue

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, edited]

permissions:
  contents: read
  issues: write

jobs:
  download-file:
    runs-on: ubuntu-latest
    steps:
      - name: Check out scripts
        uses: actions/checkout@v3

      - name: Parse issue body
        id: parse-issue-body
        uses: stefanbuck/github-issue-parser@v3

      - run: echo $JSON_STRING
        env:
          JSON_STRING: ${{ steps.parse-issue-body.outputs.jsonString }}
          
      - name: Extract RAW URL from issue body
        id: extract_url
        run: |
          FILE_URL="${{ fromJson(steps.parse-issue-body.outputs.jsonString).additional_information_optional }}"
          echo "$FILE_URL"
      
          RAW_URL=$(echo "$FILE_URL" | grep -oP '(?<=\]\().*?(?=\))')
          echo "Extracted RAW URL $RAW_URL"
                
          if [[ -z "$RAW_URL" ]]; then
            echo "No valid URL found in the issue body."
            exit 1
          fi
          
          echo "RAW_URL=$RAW_URL" >> $GITHUB_ENV
          echo "Extracted RAW URL: $RAW_URL"
          TMP_DIR="/tmp/tmp_download"
          mkdir -p "$TMP_DIR"
          FILE_NAME=$(basename "$RAW_URL")
          FILE_PATH="$TMP_DIR/$FILE_NAME"

          echo "Downloading file..."
          curl -L "$RAW_URL" -o "$FILE_PATH"

          echo "File saved to: $FILE_PATH"
          echo "FILE_PATH=$FILE_PATH" >> $GITHUB_ENV
          cat $FILE_PATH

      - name: List contents of /tmp/tmp_download
        run: ls -l /tmp/tmp_download
