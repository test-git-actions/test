name: Download File from Issue

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, edited]

permissions:
  contents: read
  issues: write

jobs:
  download-file:
    runs-on: ubuntu-latest
    steps:
      - name: Check out scripts
        uses: actions/checkout@v3

      - name: Parse issue body
        id: parse-issue-body
        uses: stefanbuck/github-issue-parser@v3

      - run: echo $JSON_STRING
        env:
          JSON_STRING: ${{ steps.parse-issue-body.outputs.jsonString }}
          
      - name: Extract RAW URL from issue body
        id: extract_url
        run: |
          FILE_URL="${{ fromJson(steps.parse-issue-body.outputs.jsonString).additional_information_optional }}"
          echo "$FILE_URL"
      
          if [[ -n "$FILE_URL" ]]; then
            echo "üì• Downloading file from: $FILE_URL"            
            RAW_URL=$(echo "$FILE_URL" | grep -oP '(?<=\]\().*?(?=\))')
            echo "Extracted RAW URL $RAW_URL"
            
            if [[ -n "$RAW_URL" ]]; then
              if [[ "$RAW_URL" == *.txt ]]; then
                echo "üìú Text file detected. Downloading and renaming..."
                TMP_DIR="/tmp/tmp_download"
                mkdir -p "$TMP_DIR"
                FILE_NAME=$(basename "$RAW_URL")
                FILE_PATH="$TMP_DIR/$FILE_NAME"
                echo "Downloading file..."
                curl -L "$RAW_URL" -o "$FILE_PATH"
                echo "File saved to: $FILE_PATH"
                echo "FILE_PATH=$FILE_PATH" >> $GITHUB_ENV
                cat $FILE_PATH
                
              elif [[ "$RAW_URL" == *.zip ]]; then
                echo "üì¶ ZIP file detected. Downloading and extracting..."
                gh api -H "Accept: application/vnd.github.v3.raw" "$FILE_URL" > pipeline.zip
                unzip pipeline.zip -d extracted_pipeline
                mv extracted_pipeline/*.yml migration.yml              
                YAML_FILE=$(find extracted_pipeline -type f -name "*.yml" | head -n 1)
                if [[ -n "$YAML_FILE" ]]; then
                  mv "$YAML_FILE" migration.yml
                  echo "‚úÖ YAML file extracted and renamed to migration.yml."
                else
                  echo "‚ùå No YAML file found inside the ZIP."
                fi                
              else
                echo "‚ö†Ô∏è Unsupported file type. Only .txt and .zip files are allowed."
              fi              
            else
              echo "‚ö†Ô∏è Unable to extract direct file URL."
            fi
          else
            echo "‚ö†Ô∏è No file URL provided. Skipping download."
          fi

      - name: List contents of /tmp/tmp_download
        run: ls -l /tmp/tmp_download
