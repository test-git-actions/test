name: Run Incremental Push

on:
  workflow_call:

permissions:
  contents: write
  actions: write
  pull-requests: write
  issues: write

jobs:
  incremental_push:
    runs-on: ubuntu-latest
    steps:
      - name: Check out scripts
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Parse issue body
        id: parse-issue-body
        uses: stefanbuck/github-issue-parser@v3

      - run: echo $JSON_STRING
        env:
          JSON_STRING: ${{ steps.parse-issue-body.outputs.jsonString }}

      - name: Extract Schedule Cron Expression
        id: extract-cron
        run: |
          case "${{ fromJson(steps.parse-issue-body.outputs.jsonString).schedule_duration }}" in
            "2 minutes")   CRON="*/2 * * * *" ;;
            "10 minutes")  CRON="*/10 * * * *" ;;
            "30 minutes")  CRON="*/30 * * * *" ;;
            "60 minutes")  CRON="0 * * * *" ;;  # Every hour
            "2 hours")     CRON="0 */2 * * *" ;;
            "4 hours")     CRON="0 */4 * * *" ;;
            "8 hours")     CRON="0 */8 * * *" ;;
            "24 hours")    CRON="0 0 * * *" ;;  # Midnight every day
            *)             CRON="0 0 * * *" ;;  # Midnight every day
          esac
          echo "CRON=$CRON" >> $GITHUB_ENV

      - name: Modify Workflow File
        run: |
          sed -i 's#cron: ".*"#cron: "${{ env.CRON }}"#' .github/workflows/incremental-sync-job.yml
          sed -i '0,/^name: .*/s/^name: .*/name: "Incremental GitHub Sync - ${{ fromJson(steps.parse-issue-body.outputs.jsonString).repository_name }}"/' .github/workflows/incremental-sync-job.yml
          
      - name: Commit and Push Changes
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git fetch origin
            git status
        
            # Check if there are any changes to commit
            if [[ -n "$(git status --porcelain)" ]]; then
              git add .
              git commit -m "Automated commit by GitHub Actions"
              git push
            else
              echo "No changes detected. Exiting."
              exit 0  # Exit with code 0 to indicate no error
            fi

      - name: Trigger Incremental GitHub Sync workflow
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/actions/workflows/incremental-sync-job.yml/dispatches \
            -f ref=main \
            -f "inputs[target_org]=${{ fromJson(steps.parse-issue-body.outputs.jsonString).target_organization }}" \
            -f "inputs[source_org]=MGMResorts" \
            -f "inputs[repo_name]=${{ fromJson(steps.parse-issue-body.outputs.jsonString).repository_name }}" \
            --header "Authorization: token $GH_TOKEN"

      # - name: Schedule the Job - Incremental Push
      #   uses: peter-evans/repository-dispatch@v1
      #   with:
      #       token: ${{ secrets.GITHUB_TOKEN }}
      #       event-type: incremental-push-job
      #       client-payload: |
      #           {
      #             "src_org": "MGMResorts",
      #             "target_org": "${{ fromJson(steps.parse-issue-body.outputs.jsonString).target_organization }}",
      #             "repo_name": "${{ fromJson(steps.parse-issue-body.outputs.jsonString).repository_name }}",
      #             "schedule_duration": "${{ fromJson(steps.parse-issue-body.outputs.jsonString).schedule_duration }}"
      #           }

